{% extends 'page.html' %}

{% block canonical_link %}{{ url_for('.person', person_id=person.id) }}{% endblock %}

{% block title %}{{ person.name }} mentions - Election Mentions{% endblock %}

{% if '2015' in person.candidacies %}
    {% set person_party=person.candidacies['2015'].party.name %}
    {% set person_constituency=person.candidacies['2015'].constituency.name %}
    {% set person_constituency_id=person.candidacies['2015'].constituency.id %}
    {% set person_year="2015" %}
{% elif '2010' in person.candidacies %}
    {% set person_party=person.candidacies['2010'].party.name %}
    {% set person_constituency=person.candidacies['2010'].constituency.name %}
    {% set person_constituency_id=person.candidacies['2010'].constituency.id %}
    {% set person_year="2010" %}
{% else %}
    {% set person_party="" %}
    {% set person_constituency="" %}
    {% set person_constituency_id="" %}
    {% set person_year="" %}
{% endif %}

{% block content %}
<div class='container'>
  {% include "header.html" %}
</div>
<div style='background:#516FFF;'>
  <div class='container'>
    <div class='row'>
      <div class='col-md-12 top-banner'>
        <div class='name'>
          <h1>{{ person.name }}</h1>
        </div>
      </div>
    </div>
  </div>
</div>
<div style='background:#FAFAFA;margin-bottom:20px;'>
  <div class='container'>
    <div class='row'>
      <div class='col-md-12 top-banner'>
      {% if person_party %}
      <div class='party-and-constituency'>
          <h2>{{ person_party }} &mdash; <a href='{{ url_for('.constituency', constituency_id=person_constituency_id) }}'>{{ person_constituency }}</a> <small>(GE {{ person_year }})</small></h2>
      </div>
      {% else %}
      <div class='party-and-constituency'>
          <h2>No known candidacies</h2>
      </div>
      {% endif %}

      {% if person.deleted %}
        <p class='text-danger'>This person has been deleted</p>
      {% endif %}
      </div>
    </div>
  </div>
</div>

{% if articles %}
<div class='container'>
  <div class='row'>
    <div class='col-md-12'>
<h3>Timeline</h3>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
<style>
svg.timeline circle {
    fill: rgba(255,255,255,0.5);
    stroke:rgba(128,128,128,1.0);
    stroke-width:2 
}

svg.timeline circle:hover {
    stroke:rgba(128,128,255,1.0);
}

svg.timeline rect.bar {
    fill: rgba(253, 221, 102, 1.00);
}

svg.timeline rect.bar_hidden {
    fill: rgba(255, 255, 255, 0.0);
}

svg.timeline text.bar {
    fill: rgba(0, 0, 0, 1.0);
    text-anchor: middle;
    opacity: 0.1;
}

svg.timeline text.bar_highlight {
    fill: black;
    opacity: 1.0;
}

svg.timeline line.axis {
    stroke:rgba(128,128,128,1.0);
    stroke-width:2;
}

svg.timeline line.marker {
    stroke:rgba(128,128,128,1.0);
    stroke-width:2;
}

svg.timeline text {
    text-anchor: middle;
}

svg.timeline line.election-marker {
}

svg.timeline text.election-text {
    fill: #999;
}
</style>

{#{% set start_time=articles[-1].order_date %}#}
{% set start_time=year_2015 %}
{% set finish_time=articles[0].order_date %}
{% set interval=finish_time - start_time %}

{% set election_frac = (elections['ge2015']['date'] - start_time).total_seconds() / interval.total_seconds() %}
{% set headspace = 80 %}{# Head space, head space, nothing could possibly go wrong! #}

<svg width="100%" height="130" class="timeline">
  <g class='inner'>
  </g>

  <text x="5%" y="{{ headspace + 40 }}">{{ start_time.date() }}</text>
  <text x="95%" y="{{ headspace + 40 }}">{{ finish_time.date() }}</text>

  <line x1="5%" y1="{{ headspace }}" x2="95%" y2="{{ headspace }}" class="axis"/>

  <line x1="5%" y1="{{ headspace }}" x2="5%" y2="90" class="marker"/>
  <line x1="95%" y1="{{ headspace }}" x2="95%" y2="90" class="marker"/>
  
  {% if 1.0 >= election_frac >= 0.0  %}
      <line x1="{{ election_frac*90 + 5 }}%" y1="{{ headspace }}" x2="{{ election_frac*90 + 5 }}%" y2="{{ headspace + 20 }}" class="marker election-marker"/>
      <text x="{{ election_frac*90 + 5 }}%" y="{{ headspace + 40 }}" class="election-text">GE 2015</text>
  {% endif %}

</svg>
<script>
    var svg = d3.select("svg.timeline g.inner");


    function labels(data) {
        var label = svg.selectAll("text.headline").data(data);
        
        label.exit().remove();

        label.enter()
             .append("text");

        label.attr("x", "50%")
             .attr("y", 20)
             .attr("class", "headline")
             .html(function(d) { return d.title; });
    }

    var article_data = [
{% for article in articles %}{"x": {{ (article.order_date - start_time).total_seconds()/interval.total_seconds() }}, "title": "{{ article.page.title }}"}{% if not loop.last %},{% endif %}{% endfor %}
    ];

    var weekly_data = [
        {% for bucket in weekly_buckets %}
            {"x1": {{ (bucket[0] - start_time).total_seconds()/interval.total_seconds() }},
             "x2": {{ ((bucket[0] - start_time).total_seconds() + 86400*7)/interval.total_seconds() }},
             "y": {{ bucket[1] }}}
        {% if not loop.last %},{% endif %}{% endfor %}
    ]

    var weekly_max = d3.max(weekly_data, function(d) { return d.y });

    var circle = svg.selectAll("circle").data(article_data);
    var rectangle_hidden = svg.selectAll("rect.bar_hidden").data(weekly_data);
    var rectangle = svg.selectAll("rect.bar").data(weekly_data);
    var rectangle_tex = svg.selectAll("text.bar").data(weekly_data);
 
    rectangle.enter().append("rect")
          .attr("x", function(d) { return (d.x1*90 + 5) + "%"; })
          .attr("y", function(d) { return {{ headspace }}-(d.y / weekly_max * 50 + 5); })
          .attr("width", function(d) { return ((d.x2 - d.x1)*90) + "%"; })
          .attr("height", function(d) { return (d.y / weekly_max * 50 + 5); })
          .attr("class", "bar");
    
    rectangle.enter().append("text")
          .attr("x", function(d) { return ((d.x1 + d.x2)/2*90 + 5) + "%"; })
          .attr("y", function(d) { return {{ headspace }}-(d.y / weekly_max * 50) - 10; })
          /*.attr("fill-opacity", function(d) { return d.y/weekly_max*0.9 + 0.1 ;})*/
          .html(function(d) { return d.y })
          .attr("id", function(d,i) { return "text-bar-" + i; })
          .attr("class", "bar");

    rectangle_hidden.enter().append("rect")
          .attr("x", function(d) { return (d.x1*90 + 5) + "%"; })
          .attr("y", function(d) { return 0; })
          .attr("width", function(d) { return ((d.x2 - d.x1)*90) + "%"; })
          .attr("height", function(d) { return {{ headspace }}; })
          .attr("class", "bar_hidden")
          .on("mouseover", function(d,i) { $("svg.timeline text#text-bar-"+i).attr("class", "bar bar_highlight"); }) /* JQuery can't set classes on SVG */
          .on("mouseout", function(d,i) { $("svg.timeline text#text-bar-"+i).attr("class", "bar"); });

    circle.enter().append("circle")
          .attr("cx", function(d) { return (d.x*90 + 5) + "%"; })
          .attr("cy", {{ headspace }})
          .attr("r", 5)
          .on("mouseover", function(d,i) { labels([{"x": (d.x*90 + 5) + "%", "title": d.title}]); });
    
</script>
    </div>
  </div>
</div>
{% endif %}

<div class='container'>
  <div class='row'>
    <div class='col-md-2 col-sm-3'>
      {% if person.image %}
        <img width='100%' class='person-image' src='{{ person.proxy_image }}/0/165' alt='Photo of {{ person.name }}'/>
      {% endif %}
      {% for year, candidacy in person.candidacies.items() %}
      <p class='person-candidacy'>
          <span class='year'>GE {{ year }}</span>
          {% if candidacy.party %}
          <span class='party'>{{ candidacy.party.name }}</span>
          {% endif %}
          {% if candidacy.constituency %}
          <span class='constituency'><a href='{{ url_for('.constituency', constituency_id=candidacy.constituency.id) }}'>{{ candidacy.constituency.name }}</a></span>
          {% endif %}
      </p>
      {% endfor %}

      <a href='http://yournextmp.com/person/{{ person.id }}'>View {{ person.name }} on YourNextMP</a>

      <h3>Written about by</h3>
      <ul class='publications'>
      {% for domain, count in domains %}
        <li class='publication'><span class='publication-name'>{{ domain['name'] }}</span> <span class='publication-count'>{{ count }}</span></li>
      {% endfor %}
      </ul>
    </div>
    {#<div class='col-md-10'>
      {% include "article_add_form.html" %}
    </div>#}
    {#<div class='col-md-10 col-sm-9'>
        <ul class='tab-nav'>
            <li><a href='{{ url_for('.person', person_id=person.id) }}'>quotes</a></li>
            <li><a href='{{ url_for('.person_articles', person_id=person.id) }}'>articles</a></li>
        </ul>
    </div>#}
    <div class='col-md-10 col-sm-9'>
        <p class='warning'>These are automatically matched articles and extracted quotes that we think are talking about {{ person.name }}. There may be errors. For example, the article may be talking about a different {{ person.name }}.</p>
        <h3>Quotes mentioning {{ person.name }}</h3>
        <ul class='quotes'>
        {% if quotes %}
        {% for quote in quotes[:5] %}
            <li class='quote'>
                <p class='quote-text'>{% if quote.truncated.left %}&hellip; {% endif %}{{ quote.html|safe }}{% if quote.truncated.right %} &hellip;{% endif %}</p>
                <p style='float: left;' class='quote-article-link'><a href='{{ url_for("article_report", doc_id=quote.article._id) }}'>report</a></p>
                <p class='quote-article-link'>
                    {% if quote.article.page.date_published %}
                        published {{ quote.article.page.date_published.strftime("%-d %b %Y") }} 
                    {% endif %}
                    in <a href='{{ quote.article.page.urls[0] }}'>{{ quote.article.page.title }}</a> ({{ quote.article.domain }})</p>
            </li>
        {% endfor %}
        </ul>
        <a href='{{ url_for('.person_quotes', person_id=person.id) }}' class='btn btn-default'>see all quotes mentioning {{ person.name }}</a>
        {% else %}
        <p class='warning'>We don't know of any quotes mentioning {{ person.name }}.</p>
        {% endif %}

        <h3>Articles mentioning {{ person.name }}</h3>
        {% set num_articles=articles|length %}
        {% if num_articles == 0 %}
        <p class='warning'>We don't know of any news articles about {{ person.name }}. Why not <a href='http://www.google.com/#q={{ person.name }} {{ person_constituency }} {{ person_party }}'>try to find one</a> and add it?</p>
        {% include "article_add_form.html" %}
        {% else %}
        {#<p class='warning'>These are automatically matched pages that we think are talking about {{ person.name }}. There may be errors. For example, the article may be talking about a different {{ person.name }}.</p>#}
        {% set quotes_closed=False %}
        {% include "article_list.html" %}
        <script>
            {% for year, candidacy in person.candidacies.items() %}
            $('.quote-constituency-{{ candidacy.constituency.id }}').removeClass('quote-closed').show();
            $('.quote-constituency-{{ candidacy.constituency.id }}-highlight').addClass("constituency-highlight");
            {% endfor %}

            $('.quote-candidate-{{ person.id }}').removeClass('quote-closed').show();
            $('.quote-candidate-{{ person.id }}-highlight').addClass("candidate-highlight");

            /*recalculate_extra_quotes();*/
        </script>
        {% endif %}
    </div>
  </div>
</div>
<div class='footer'>
<div class='container'>
  {% include "footer.html" %}
</div>
</div>
{% endblock content %}
